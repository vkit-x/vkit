# Camera-model Based Distortion

## `camera_cubic_curve`

Description: Simulate 3D surface curving effects based on camera model and cubic spline, as described in [Page dewarping](https://mzucker.github.io/2016/08/15/page-dewarping.html)

Effect:

<div align="center">
    <video width="75%" height="75%" autoplay="true" muted="true" playsinline="true" loop="true" controls="ture">
        <source src="/geo/camera_cubic_curve.mp4" type="video/mp4" />
    </video>
</div>

In the animation above:

* Top left: The distorted image, `Image`
* Top right: The distorted polygons, `Polygon`
* Middle left: The distorted image grid, `ImageGrid`
* Middle right: The active region, `ImageMask`
* Bottom left: The distorted image mask, `ImageMask`
* Bottom right: The distorted image score map, `ImageScoreMap`

Import statement:

```python
from vkit.augmentation.geometric_distortion import (
    CameraModelConfig,
    CameraCubicCurveConfig,
    camera_cubic_curve,
)
```

Configuration type:

```python
@attr.define
class CameraModelConfig:
    rotation_unit_vec: Sequence[float]
    rotation_theta: float
    principal_point: Optional[Sequence[float]] = None
    focal_length: Optional[float] = None
    camera_distance: Optional[float] = None


@attr.define
class CameraCubicCurveConfig:
    curve_alpha: float
    curve_beta: float
    curve_direction: float
    curve_scale: float
    camera_model_config: CameraModelConfig
    grid_size: int
```

Attributes of `CameraModelConfig` describe the camera model:

* `rotation_unit_vec`: An unit rotation vector, as explained in [cv.Rodrigues](https://docs.opencv.org/4.5.3/d9/d0c/group__calib3d.html#ga61585db663d9da06b68e70cfbf6a1eac)
* `rotation_theta`: The angle of rotation,  accepting degrees in range  `[-180, 180]`. Positive value corresponds to the rotation direction following the right-hand rule
* `principal_point`: Optional. The intersection point of the optical axis and the image, described in 2D coordinate with regards to the original image. If not provided, the center of image will be selected as the principal point
* `focal_length`: Optional. Define the focal length in pixels. If not provided, the large one among the image height and width will be selected as the focal length
* `camera_distance`: Optional. Define the distance between the origin of the camera coordinate and principal point. If not provided, the algorithm will estimate an appropriate value for you

Attributes of `CameraCubicCurveConfig` control the curving effect

* `curve_alpha`: The slope of the left endpoint, in the projection to the curve direction
* `curve_beta`: The slope of the right endpoint, in the projection to the curve direction
* `curve_direction`:  Define the curve direction, accepting angles in range  `[0, 180]`. The curve effect will be generated along this direction. For example, with angle `0`, the curve is generated along the horizontal direction, while `90` for the vertical direction. For each position in the original image, a delta value in the z axis will be generated based on the projection and the cubic spline, hence simulating the curve effect
* `curve_scale`: Control the scale of the delta value in the z axis. Recommended value: `1.0`
* `grid_size`: The grid size for rendering. The smaller, the better effect, but with the cost of computation performance

## `camera_plane_line_fold`

Description: Simulate 3D surface folding effects based on camera model, as described in  [DocUNet: Document Image Unwarping via A Stacked U-Net](https://www3.cs.stonybrook.edu/~cvl/docunet.html)

Effect:

<div align="center">
    <video width="75%" height="75%" autoplay="true" muted="true" playsinline="true" loop="true" controls="ture">
        <source src="/geo/camera_plane_line_fold.mp4" type="video/mp4" />
    </video>
</div>

Import statement:

```python
from vkit.augmentation.geometric_distortion import (
    CameraModelConfig,
    CameraPlaneLineFoldConfig,
    camera_plane_line_fold,
)
```

Configuration type:

```python
@attr.define
class CameraPlaneLineFoldConfig:
    fold_point: Tuple[float, float]
    fold_direction: float
    fold_perturb_vec: Tuple[float, float, float]
    fold_alpha: float
    camera_model_config: CameraModelConfig
    grid_size: int
```

Parameters:

* `fold_point`  and  `fold_direction`  define a standard line.  `fold_point` is a point in the image 2D coordinate.  `fold_direction`  is the clockwise angle of line through `fold_point` , with the value in range `[0, 180]`
* `fold_perturb_vec`:  The perturbed vector, defining the direction and strength of the distortion. For each position in the original image,  the weight of perturbed vector will be generated based on the distance to the standard line. And the distorted position is generated by the formula `p + w * fold_perturb_vec`, where `p` represents the original position
* `fold_alpha`: Control the weight `w = fold_alpha / (fold_alpha + d)`, where `d` represents the the normalized distance to the standard line. The smaller `fold_alpha` (closer to `0`), the stronger folding effect. Recommended value: `0.5`


## `camera_plane_line_curve`

Description: Simulate 3D surface curving effects based on camera model, as described in  [DocUNet: Document Image Unwarping via A Stacked U-Net](https://www3.cs.stonybrook.edu/~cvl/docunet.html)

Effect:

<div align="center">
    <video width="75%" height="75%" autoplay="true" muted="true" playsinline="true" loop="true" controls="ture">
        <source src="/geo/camera_plane_line_curve.mp4" type="video/mp4" />
    </video>
</div>

Import statement:

```python
from vkit.augmentation.geometric_distortion import (
    CameraModelConfig,
    CameraPlaneLineCurveConfig,
    camera_plane_line_curve,
)
```

Configuration type:

```python
@attr.define
class CameraPlaneLineCurveConfig:
    curve_point: Tuple[float, float]
    curve_direction: float
    curve_perturb_vec: Tuple[float, float, float]
    curve_alpha: float
    camera_model_config: CameraModelConfig
    grid_size: int

```

Parameters:

* `curve_point`  and  `curve_direction`  define a standard line, same as `CameraPlaneLineFoldConfig`
* `curve_perturb_vec`: The perturbed vector, same as `CameraPlaneLineFoldConfig`
* `curve_alpha`:  Control the weight `w = 1 - d^curve_alpha`, similar to `CameraPlaneLineFoldConfig`. Recommended value: `2.0`

